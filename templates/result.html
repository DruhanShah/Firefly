<!DOCTYPE html>
<html>
<head>
    <title>Result - Code Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow: auto; }
        .file-list { margin-bottom: 20px; }
        .terminal { 
            background-color: #000; 
            color: #fff; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto;
            font-family: monospace;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .input-form {
            display: flex;
            margin-bottom: 20px;
        }
        .input-form input {
            flex-grow: 1;
            padding: 5px;
            margin-right: 10px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Processing Complete</h1>
    
    <div>
        <a href="{{ url_for('download_file', filename=output_archive) }}" class="btn">Download All Files</a>
        <a href="{{ url_for('index') }}" class="btn">Back to Home</a>
    </div>
    
    <h2>Generated Files:</h2>
    <div id="file-list" class="file-list">
        <p>Loading file list...</p>
    </div>
    
    <div id="file-viewer" class="hidden">
        <h3 id="file-name"></h3>
        <pre id="file-content"></pre>
    </div>
    
    <div id="code-execution" class="hidden">
        <h3>Code Execution Terminal</h3>
        <div id="terminal" class="terminal"></div>
        
        <div class="input-form">
            <input type="text" id="user-input" placeholder="Enter your input here...">
            <button id="send-input">Send</button>
        </div>
        
        <button id="stop-execution">Stop Execution</button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const outputId = '{{ output_archive }}'.replace('_output.zip', '');
            
            // Load file list
            fetch('/list_files/' + outputId)
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('file-list');
                    fileList.innerHTML = '';
                    
                    if (data.files.length === 0) {
                        fileList.innerHTML = '<p>No files found</p>';
                        return;
                    }
                    
                    const ul = document.createElement('ul');
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        
                        const viewLink = document.createElement('a');
                        viewLink.href = '#';
                        viewLink.textContent = file;
                        viewLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            viewFile(outputId, file);
                        });
                        
                        li.appendChild(viewLink);
                        
                        // Add a run link for Python files
                        if (file.endsWith('.py')) {
                            const runLink = document.createElement('a');
                            runLink.href = '#';
                            runLink.textContent = ' (Run)';
                            runLink.addEventListener('click', function(e) {
                                e.preventDefault();
                                runCode(outputId, file);
                            });
                            li.appendChild(runLink);
                        }
                        
                        ul.appendChild(li);
                    });
                    
                    fileList.appendChild(ul);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('file-list').innerHTML = '<p>Error loading files</p>';
                });
            
            // Function to view a file
            function viewFile(outputId, filename) {
                fetch(`/view_file/${outputId}/${filename}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('file-name').textContent = filename;
                        document.getElementById('file-content').textContent = data.content;
                        document.getElementById('file-viewer').classList.remove('hidden');
                        document.getElementById('code-execution').classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error viewing file');
                    });
            }
            
            // Function to run code
            let executionId = null;
            function runCode(outputId, filename) {
                fetch(`/run_code/${outputId}/${filename}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    executionId = data.execution_id;
                    document.getElementById('terminal').innerHTML = `<div>${data.output}</div>`;
                    document.getElementById('file-viewer').classList.add('hidden');
                    document.getElementById('code-execution').classList.remove('hidden');
                    
                    // Set up polling for output
                    pollOutput();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error running code');
                });
            }
            
            // Poll for new output
            function pollOutput() {
                if (!executionId) return;
                
                fetch(`/check_output/${executionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.output) {
                            const terminal = document.getElementById('terminal');
                            terminal.innerHTML += `<div>${data.output}</div>`;
                            terminal.scrollTop = terminal.scrollHeight;
                        }
                        
                        if (data.running) {
                            setTimeout(pollOutput, 1000);
                        } else {
                            executionId = null;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
            
            // Send user input to the running program
            document.getElementById('send-input').addEventListener('click', function() {
                if (!executionId) return;
                
                const input = document.getElementById('user-input').value;
                document.getElementById('user-input').value = '';
                
                fetch(`/send_input/${executionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ input: input + '\n' })
                })
                .then(response => response.json())
                .then(data => {
                    const terminal = document.getElementById('terminal');
                    terminal.innerHTML += `<div>&gt; ${input}</div>`;
                    terminal.scrollTop = terminal.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
            
            // Allow sending input with Enter key
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('send-input').click();
                }
            });
            
            // Stop code execution
            document.getElementById('stop-execution').addEventListener('click', function() {
                if (!executionId) return;
                
                fetch(`/stop_execution/${executionId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    executionId = null;
                    const terminal = document.getElementById('terminal');
                    terminal.innerHTML += `<div>Program execution stopped</div>`;
                    terminal.scrollTop = terminal.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    </script>
</body>
</html>